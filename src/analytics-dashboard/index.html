<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Analytics Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            color: #333;
            font-size: 2.5em;
            font-weight: bold;
        }
        
        .stat-unit {
            color: #999;
            font-size: 0.5em;
            margin-left: 5px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .query-list {
            list-style: none;
        }
        
        .query-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .query-item:last-child {
            border-bottom: none;
        }
        
        .query-text {
            flex: 1;
            color: #333;
            font-size: 1.1em;
        }
        
        .query-count {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 15px;
        }
        
        .source-bars {
            margin-top: 20px;
        }
        
        .source-bar {
            margin-bottom: 15px;
        }
        
        .source-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #666;
        }
        
        .bar-container {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            padding-left: 15px;
            color: white;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 50px;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: block;
            margin: 0 auto 30px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .recent-query {
            padding: 12px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .recent-query-text {
            color: #333;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .recent-query-meta {
            color: #666;
            font-size: 0.85em;
            display: flex;
            gap: 15px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .badge-cached {
            background: #51cf66;
            color: white;
        }
        
        .badge-fresh {
            background: #ff6b6b;
            color: white;
        }
    
    .cost-summary {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .cost-metric {
      flex: 1;
      min-width: 200px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .cost-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .cost-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }
    .cost-value.savings {
      color: #10b981;
    }
    .cost-sublabel {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }
    .recommendations {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .recommendation-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #f0f9ff;
      border-left: 3px solid #3b82f6;
      border-radius: 4px;
      line-height: 1.6;
    }
    .savings-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #10b981;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .expensive-queries {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .expensive-query {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: #fff3cd;
      border-left: 3px solid #ffc107;
      border-radius: 4px;
    }
    .query-rank {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #ffc107;
      color: white;
      border-radius: 50%;
      font-weight: 700;
      flex-shrink: 0;
    }
    .query-details {
      flex: 1;
    }
    .query-text {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    .query-stats {
      font-size: 12px;
      color: #666;
    }

    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Search Analytics Dashboard</h1>
        
        <button class="refresh-btn" onclick="loadDashboard()">‚Üª Refresh Data</button>
        
        <div id="loading" class="loading">Loading analytics...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Queries</div>
                    <div class="stat-value" id="totalQueries">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Success Rate</div>
                    <div class="stat-value" id="successRate">0<span class="stat-unit">%</span></div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Cache Hit Rate</div>
                    <div class="stat-value" id="cacheRate">0<span class="stat-unit">%</span></div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Avg Response Time</div>
                    <div class="stat-value" id="avgTime">0<span class="stat-unit">ms</span></div>
                </div>
            </div>
            
            <div class="section">
                <h2 class="section-title">üìä Source Distribution</h2>
                <div class="source-bars" id="sourceBars"></div>
            </div>
            
            <div class="section">
                <h2 class="section-title">üî• Top 10 Queries</h2>
                <ul class="query-list" id="topQueries"></ul>
            </div>
            
            <div class="section">
                <h2 class="section-title">üïê Recent Queries</h2>
                <div id="recentQueries"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://analytics-service.librechat.svc.cluster.local:3008/api/analytics/dashboard';
        
        async function loadDashboard() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                
                document.getElementById('totalQueries').textContent = data.totalQueries.toLocaleString();
                document.getElementById('successRate').innerHTML = data.successRate + '<span class="stat-unit">%</span>';
                document.getElementById('cacheRate').innerHTML = data.cacheHitRate + '<span class="stat-unit">%</span>';
                document.getElementById('avgTime').innerHTML = data.avgResponseTime.toLocaleString() + '<span class="stat-unit">ms</span>';
                
                renderSourceBars(data.sourceBreakdown);
                renderTopQueries(data.topQueries);
                renderRecentQueries(data.recentQueries);
                
                loading.style.display = 'none';
                dashboard.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Error loading dashboard: ' + err.message;
            }
        }
        
        function renderSourceBars(sources) {
            const container = document.getElementById('sourceBars');
            container.innerHTML = '';
            
            const total = Object.values(sources).reduce((a, b) => a + b, 0);
            if (total === 0) {
                container.innerHTML = '<p style="color: #999;">No source data yet</p>';
                return;
            }
            
            Object.entries(sources).forEach(([source, count]) => {
                const percentage = Math.round((count / total) * 100);
                
                const barDiv = document.createElement('div');
                barDiv.className = 'source-bar';
                barDiv.innerHTML = `
                    <div class="source-label">
                        <span>${source.charAt(0).toUpperCase() + source.slice(1)}</span>
                        <span>${count} queries (${percentage}%)</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%">${percentage}%</div>
                    </div>
                `;
                container.appendChild(barDiv);
            });
        }
        
        function renderTopQueries(queries) {
            const container = document.getElementById('topQueries');
            container.innerHTML = '';
            
            if (!queries || queries.length === 0) {
                container.innerHTML = '<li class="query-item"><span class="query-text" style="color: #999;">No queries yet</span></li>';
                return;
            }
            
            queries.forEach(q => {
                const li = document.createElement('li');
                li.className = 'query-item';
                li.innerHTML = `
                    <span class="query-text">${escapeHtml(q._id)}</span>
                    <span class="query-count">${q.count}</span>
                `;
                container.appendChild(li);
            });
        }
        
        function renderRecentQueries(queries) {
            const container = document.getElementById('recentQueries');
            container.innerHTML = '';
            
            if (!queries || queries.length === 0) {
                container.innerHTML = '<p style="color: #999;">No recent queries</p>';
                return;
            }
            
            queries.forEach(q => {
                const div = document.createElement('div');
                div.className = 'recent-query';
                
                const timestamp = new Date(q.timestamp).toLocaleString();
                const badge = q.cached ? 
                    '<span class="badge badge-cached">Cached</span>' : 
                    '<span class="badge badge-fresh">Fresh</span>';
                
                div.innerHTML = `
                    <div class="recent-query-text">${escapeHtml(q.query)}</div>
                    <div class="recent-query-meta">
                        <span>${timestamp}</span>
                        <span>${q.responseTime}ms</span>
                        <span>${q.resultsCount} results</span>
                        ${badge}
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        loadDashboard();
        setInterval(loadDashboard, 30000);
    
    function renderCostOptimization(costData) {
      const container = document.getElementById('costOptimization');
      if (!costData || !costData.totalEstimatedCost) {
        container.innerHTML = '<p style="color: #666;">No cost data available yet.</p>';
        return;
      }
      
      let html = '<div class="cost-summary">';
      html += '<div class="cost-metric">';
      html += '<div class="cost-label">Estimated Monthly Cost</div>';
      html += '<div class="cost-value">$' + costData.totalEstimatedCost.toFixed(2) + '</div>';
      html += '</div>';
      html += '<div class="cost-metric">';
      html += '<div class="cost-label">Potential Monthly Savings</div>';
      html += '<div class="cost-value savings">$' + costData.potentialSavings.toFixed(2) + '</div>';
      html += '<div class="cost-sublabel">(with optimizations)</div>';
      html += '</div>';
      html += '</div>';
      
      html += '<h3 style="margin-top: 24px; margin-bottom: 12px; color: #333;">üí° Optimization Recommendations</h3>';
      html += '<ul class="recommendations">';
      
      costData.recommendations.forEach(rec => {
        html += '<li class="recommendation-item">';
        html += '<strong>' + rec.title + '</strong>: ' + rec.description;
        html += ' <span class="savings-badge">Save $' + rec.savings.toFixed(2) + '/mo</span>';
        html += '</li>';
      });
      
      html += '</ul>';
      
      if (costData.expensiveQueries && costData.expensiveQueries.length > 0) {
        html += '<h3 style="margin-top: 24px; margin-bottom: 12px; color: #333;">‚ö†Ô∏è Most Expensive Queries</h3>';
        html += '<div class="expensive-queries">';
        costData.expensiveQueries.forEach((q, idx) => {
          html += '<div class="expensive-query">';
          html += '<span class="query-rank">' + (idx + 1) + '</span>';
          html += '<div class="query-details">';
          html += '<div class="query-text">' + q.query + '</div>';
          html += '<div class="query-stats">';
          html += 'Avg: ' + q.avgResponseTime + 'ms | Cost: $' + q.estimatedCost.toFixed(4) + ' per query | Count: ' + q.count;
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      container.innerHTML = html;
    }

    </script>
</body>
</html>